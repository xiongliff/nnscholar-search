<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NNScholar - 医学文献智能检索与分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-color: #4169E1;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
        }

        body {
            padding-top: 70px;
            background-color: var(--background-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1e3a8a);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.5rem;
            color: white !important;
        }

        .container {
            max-width: 1000px;
            padding: 0 20px;
        }

        .card {
            border: none;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            transition: transform var(--transition-speed);
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .form-control {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            padding: 0.75rem;
            transition: border-color var(--transition-speed);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(65, 105, 225, 0.25);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all var(--transition-speed);
        }

        .btn-primary:hover {
            background-color: #2a4db7;
            transform: translateY(-1px);
        }

        .filters-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .filter-title {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .custom-checkbox {
            display: inline-flex;
            align-items: center;
            margin-right: 1rem;
        }

        .result-card {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
            transition: all var(--transition-speed);
        }

        .result-card:hover {
            transform: translateX(4px);
        }

        .result-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .result-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            color: var(--secondary-color);
        }

        .meta-item i {
            margin-right: 0.5rem;
            width: 16px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .export-section {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .export-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .export-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .export-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .export-item i {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }

        #search-strategy-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        #search-strategy {
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
        }

        #search-stats {
            margin: 20px 0;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .search-form {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        #search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
        }

        #search-btn {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        #search-btn:hover {
            background-color: #2a4db7;
            transform: translateY(-1px);
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.warning { background-color: #ffc107; color: #000; }
        .toast.info { background-color: #17a2b8; }

        .mode-container {
            transition: all 0.3s ease-in-out;
        }
        
        .analysis-chart {
            min-height: 400px;
            width: 100%;
            background: #ffffff;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .no-data-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
            text-align: center;
        }
        
        /* 调整图表卡片样式 */
        .chart-card {
            margin-bottom: 2rem;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .chart-card .card-title {
            color: #4169E1;
            font-weight: 600;
            margin-bottom: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .btn-check:checked + .btn-outline-light {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* 添加热点作者表格样式 */
        .table-responsive {
            margin-top: 1rem;
        }
        
        .table {
            font-size: 0.9rem;
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .author-rank {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .author-years {
            font-size: 0.8rem;
            color: var(--secondary-color);
        }

        /* 添加搜索模式切换样式 */
        .search-mode-toggle {
            margin-bottom: 1rem;
        }
        
        .search-mode-toggle .btn-group {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .search-mode-toggle .btn {
            flex: 1;
            text-align: center;
        }
        
        /* 调整输入框样式 */
        #search-input {
            min-height: 60px;
            resize: vertical;
            transition: min-height 0.3s ease;
        }
        
        #search-input.paragraph-mode {
            min-height: 120px;
        }
        
        /* 段落模式的结果样式 */
        .sentence-result {
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            margin-bottom: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .sentence-text {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .papers-list {
            margin-top: 1rem;
        }
        
        .paper-item {
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .paper-item:last-child {
            border-bottom: none;
        }

        /* 添加页脚样式 */
        .footer {
            background: linear-gradient(135deg, var(--primary-color), #1e3a8a);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
            text-align: center;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        .footer p {
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.6;
            opacity: 0.9;
        }
        
        .footer .developer-info {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .footer .wechat {
            font-weight: bold;
            color: #fff;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-book-medical me-2"></i>
                NNScholar
            </a>
            <!-- 添加模式切换按钮 -->
            <div class="ms-auto">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="search-mode" id="mode-normal" value="normal" checked>
                    <label class="btn btn-outline-light" for="mode-normal">
                        <i class="fas fa-search me-1"></i>文献检索
                    </label>
                    
                    <input type="radio" class="btn-check" name="search-mode" id="mode-analysis" value="analysis">
                    <label class="btn btn-outline-light" for="mode-analysis">
                        <i class="fas fa-chart-line me-1"></i>热点分析
                    </label>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="toast-container"></div>

        <!-- 文献检索模式 -->
        <div id="normal-mode-container" class="mode-container">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-search me-2"></i>
                        文献检索
                    </h5>
                    <div class="search-container">
                        <!-- 添加搜索模式切换 -->
                        <div class="search-mode-toggle mb-3">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="input-mode" id="mode-single" value="single" checked>
                                <label class="btn btn-outline-primary" for="mode-single">
                                    <i class="fas fa-search me-1"></i>单句模式
                                </label>
                                
                                <input type="radio" class="btn-check" name="input-mode" id="mode-paragraph" value="paragraph">
                                <label class="btn btn-outline-primary" for="mode-paragraph">
                                    <i class="fas fa-paragraph me-1"></i>段落模式
                                </label>
                            </div>
                            <div class="d-flex align-items-center mt-2">
                                <small class="form-text text-muted me-3">段落模式：可一次性输入多个句子，系统将分别分析每句话的相关文献</small>
                                <div id="paragraph-options" style="display: none;">
                                    <select class="form-select form-select-sm" id="papers-per-sentence">
                                        <option value="5">每句显示5篇</option>
                                        <option value="10">每句显示10篇</option>
                                        <option value="20">每句显示20篇</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="search-form">
                            <textarea id="search-input" class="form-control" rows="3" 
                                    placeholder="请输入搜索关键词..."></textarea>
                            <button id="search-btn">生成检索策略</button>
                        </div>

                        <!-- 添加检索策略显示和编辑区域 -->
                        <div id="search-strategy-container" style="display: none;" class="mt-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">检索策略</h5>
                                    <div class="form-group">
                                        <textarea id="search-strategy" class="form-control" rows="6"></textarea>
                                    </div>
                                    <div class="d-flex justify-content-between mt-3">
                                        <button id="modify-strategy-btn" class="btn btn-secondary">修改检索策略</button>
                                        <button id="execute-search-btn" class="btn btn-primary">开始检索</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 添加检索结果统计信息 -->
                        <div id="search-stats" style="display: none;" class="mt-4">
                            <div class="alert alert-info">
                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="fas fa-search me-2"></i>
                                            初始检索到相关文献：<strong id="total-count">0</strong> 篇
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="fas fa-filter me-2"></i>
                                            符合筛选条件的文献：<strong id="filtered-count">0</strong> 篇
                                        </span>
                                    </div>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-primary" role="progressbar" 
                                            style="width: 0%"
                                            aria-valuenow="0" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-muted small">
                                        <i class="fas fa-info-circle me-1"></i>
                                        筛选条件包括：年份、影响因子、JCR分区、CAS分区
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 添加筛选条件区域 -->
                        <div class="filters-section mt-4">
                            <div class="filter-group">
                                <h6 class="filter-title">发表年份</h6>
                                <div class="d-flex gap-2">
                                    <input type="number" id="year-start" class="form-control form-control-sm" placeholder="起始年份">
                                    <span class="align-self-center">-</span>
                                    <input type="number" id="year-end" class="form-control form-control-sm" placeholder="结束年份">
                                </div>
                            </div>

                            <div class="filter-group">
                                <h6 class="filter-title">影响因子</h6>
                                <input type="number" id="min-if" class="form-control form-control-sm" placeholder="最低影响因子" step="0.1">
                            </div>

                            <div class="filter-group">
                                <h6 class="filter-title">JCR分区</h6>
                                <div class="checkbox-group">
                                    <label class="custom-checkbox">
                                        <input type="checkbox" name="jcr" value="Q1"> Q1
                                    </label>
                                    <label class="custom-checkbox">
                                        <input type="checkbox" name="jcr" value="Q2"> Q2
                                    </label>
                                    <label class="custom-checkbox">
                                        <input type="checkbox" name="jcr" value="Q3"> Q3
                                    </label>
                                    <label class="custom-checkbox">
                                        <input type="checkbox" name="jcr" value="Q4"> Q4
                                    </label>
                                </div>
                            </div>

                            <div class="filter-group">
                                <h6 class="filter-title">中科院分区</h6>
                                <div class="checkbox-group">
                                    <label class="custom-checkbox">
                                        <input type="checkbox" name="cas" value="1"> 1区
                                    </label>
                                    <label class="custom-checkbox">
                                        <input type="checkbox" name="cas" value="2"> 2区
                                    </label>
                                    <label class="custom-checkbox">
                                        <input type="checkbox" name="cas" value="3"> 3区
                                    </label>
                                    <label class="custom-checkbox">
                                        <input type="checkbox" name="cas" value="4"> 4区
                                    </label>
                                </div>
                            </div>

                            <div class="filter-group">
                                <h6 class="filter-title">显示数量</h6>
                                <select id="papers-limit" class="form-select form-select-sm">
                                    <option value="10">10篇</option>
                                    <option value="20">20篇</option>
                                    <option value="50">50篇</option>
                                    <option value="100">100篇</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 热点分析模式 -->
        <div id="analysis-mode-container" class="mode-container" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-line me-2"></i>
                        期刊热点分析
                    </h5>
                    
                    <!-- 期刊选择 -->
                    <div class="form-group mb-3">
                        <label class="form-label">期刊名称</label>
                        <input type="text" class="form-control" id="journal-input" placeholder="请输入期刊名称（例如：Radiology）">
                        <div class="form-text text-muted">请输入完整的期刊名称，支持任意PubMed收录的期刊</div>
                    </div>
                    
                    <!-- 关键词方向（可选） -->
                    <div class="form-group mb-3">
                        <label class="form-label">关键词方向（可选）</label>
                        <input type="text" class="form-control" id="keywords-input" placeholder="输入感兴趣的研究方向关键词，多个关键词请用逗号分隔">
                        <div class="form-text text-muted">如果不填写，将分析所有研究方向</div>
                    </div>
                    
                    <!-- 时间范围选择 -->
                    <div class="form-group mb-3">
                        <label class="form-label">分析时间范围</label>
                        <div class="d-flex gap-2">
                            <input type="number" class="form-control" id="analysis-year-start" placeholder="起始年份">
                            <span class="align-self-center">-</span>
                            <input type="number" class="form-control" id="analysis-year-end" placeholder="结束年份">
                        </div>
                    </div>
                    
                    <!-- 分析按钮 -->
                    <button class="btn btn-primary" id="analyze-btn">
                        <i class="fas fa-chart-bar me-1"></i>
                        开始分析
                    </button>
                    
                    <!-- 分析结果展示区域 -->
                    <div id="analysis-results" class="mt-4" style="display: none;">
                        <!-- 热点主题热力图 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h6 class="card-title">研究热点分布</h6>
                                <div id="heatmap-container" class="analysis-chart"></div>
                            </div>
                        </div>
                        
                        <!-- 热点词云 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h6 class="card-title">热点词云</h6>
                                <div id="wordcloud-container" class="analysis-chart"></div>
                            </div>
                        </div>
                        
                        <!-- 趋势图 -->
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">研究趋势变化</h6>
                                <div id="trend-container" class="analysis-chart"></div>
                            </div>
                        </div>

                        <!-- 热点作者 -->
                        <div class="card mt-4">
                            <div class="card-body">
                                <h6 class="card-title">热点作者排名</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>排名</th>
                                                <th>作者</th>
                                                <th>发文总数</th>
                                                <th>第一作者</th>
                                                <th>通讯作者</th>
                                                <th>发文年份</th>
                                            </tr>
                                        </thead>
                                        <tbody id="hot-authors-table">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p class="mt-3">正在检索中，请稍候...</p>
    </div>
    
    <div id="results" class="card" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">
                <i class="fas fa-list-ul me-2"></i>
                检索结果
            </h5>
            <div id="resultsList"></div>
        </div>
    </div>

    <!-- 添加页脚 -->
    <footer class="footer">
        <div class="container">
            <p>NNscholar由华中科技大学同济医学院附属同济医院的刘远康博士开发，免费开源。</p>
            <p class="developer-info">若有部署或其他需求，请联系微信：<span class="wechat">Blackbirdflyinthesky</span></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSearchStrategy = '';
        let currentFilters = {};

        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toastContainer.removeChild(toast), 300);
            }, 3000);
        }

        function showLoading(message = '正在处理中...') {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.querySelector('p').textContent = message;
                loading.style.display = 'block';
            }
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = 'none';
            }
        }

        function displayResults(papers) {
            const resultsList = document.getElementById('resultsList');
            const results = document.getElementById('results');
            
            if (!papers || papers.length === 0) {
                resultsList.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        未找到相关文献
                    </div>`;
                results.style.display = 'block';
                return;
            }

            resultsList.innerHTML = papers.map((paper, index) => `
                <div class="card result-card">
                    <div class="card-body">
                        <h6 class="result-title">
                            ${index + 1}. ${paper.title}
                        </h6>
                        <div class="result-meta">
                            <div class="meta-item">
                                <i class="fas fa-users"></i>
                                ${paper.authors ? paper.authors.join(', ') : '无作者信息'}
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                ${paper.pub_year || '无日期信息'}
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-book"></i>
                                ${paper.journal_info ? paper.journal_info.title : '无期刊信息'}
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-chart-line"></i>
                                IF: ${paper.journal_info ? paper.journal_info.impact_factor : 'N/A'}
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-star"></i>
                                JCR: ${paper.journal_info ? paper.journal_info.jcr_quartile : 'N/A'}
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-award"></i>
                                CAS: ${paper.journal_info ? paper.journal_info.cas_quartile : 'N/A'}
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-percentage"></i>
                                相关度: ${paper.relevance ? paper.relevance.toFixed(1) : 0}%
                            </div>
                        </div>
                        <a href="${paper.url}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-external-link-alt me-1"></i>
                            查看原文
                        </a>
                    </div>
                </div>
            `).join('');

            results.style.display = 'block';
        }

        document.getElementById('search-btn').addEventListener('click', function() {
            const query = document.getElementById('search-input').value.trim();
            const mode = document.querySelector('input[name="input-mode"]:checked').value;
            const papersPerSentence = mode === 'paragraph' ? 
                parseInt(document.getElementById('papers-per-sentence').value) : 10;
            const yearStart = document.getElementById('year-start').value;
            const yearEnd = document.getElementById('year-end').value;
            
            if (!query) {
                showToast('请输入搜索内容', 'warning');
                return;
            }

            // 显示加载状态
            showLoading(mode === 'paragraph' ? '正在分析段落...' : '正在生成检索策略...');

            // 构建请求数据对象
            const requestData = {
                query: query,
                mode: mode,
                papers_per_sentence: papersPerSentence,
                generate_only: mode === 'single',  // 只在单句模式下生成检索策略
                execute_search: mode === 'paragraph',  // 在段落模式下直接执行检索
                year_start: yearStart || null,
                year_end: yearEnd || null
            };

            // 发送请求
            fetch('/api/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => handleFetchError(response))
            .then(data => {
                hideLoading();
                if (data.success) {
                    if (mode === 'single') {
                        // 单句模式：显示检索策略
                        currentSearchStrategy = data.search_strategy;
                        const strategyTextarea = document.getElementById('search-strategy');
                        strategyTextarea.value = data.search_strategy;
                        strategyTextarea.readOnly = false;
                        document.getElementById('search-strategy-container').style.display = 'block';
                        document.getElementById('results').style.display = 'none';
                        document.getElementById('search-stats').style.display = 'none';
                        showToast('检索策略已生成，您可以进行修改', 'success');
                    } else {
                        // 段落模式：直接显示结果
                        document.getElementById('search-strategy-container').style.display = 'none';
                        displayParagraphResults(data);
                    }
                } else {
                    showToast(data.error || '处理失败', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                showToast('处理过程中发生错误: ' + error.message, 'error');
                console.error('Error:', error);
            });
        });

        document.getElementById('modify-strategy-btn').addEventListener('click', function() {
            const strategyTextarea = document.getElementById('search-strategy');
            strategyTextarea.readOnly = false;
            strategyTextarea.focus();
        });

        // 添加筛选条件更新函数
        function updateFilters() {
            const yearStart = document.getElementById('year-start').value;
            const yearEnd = document.getElementById('year-end').value;
            const minIf = document.getElementById('min-if').value;
            const jcrCheckboxes = document.querySelectorAll('input[name="jcr"]:checked');
            const casCheckboxes = document.querySelectorAll('input[name="cas"]:checked');
            const papersLimit = document.getElementById('papers-limit').value;

            currentFilters = {
                year_start: yearStart || null,
                year_end: yearEnd || null,
                min_if: minIf || null,
                jcr_quartile: Array.from(jcrCheckboxes).map(cb => cb.value),
                cas_quartile: Array.from(casCheckboxes).map(cb => cb.value),
                papers_limit: papersLimit
            };
        }

        // 为所有筛选条件添加事件监听器
        document.querySelectorAll('.filter-group input, .filter-group select').forEach(element => {
            element.addEventListener('change', () => {
                updateFilters();
                // 如果已经有搜索结果，自动重新执行搜索
                if (document.getElementById('results').style.display !== 'none') {
                    document.getElementById('execute-search-btn').click();
                }
            });
        });

        document.getElementById('execute-search-btn').addEventListener('click', function() {
            const query = document.getElementById('search-input').value.trim();
            const searchStrategy = document.getElementById('search-strategy').value.trim();
            const yearStart = document.getElementById('year-start').value;
            const yearEnd = document.getElementById('year-end').value;

            if (!query) {
                showToast('请输入搜索关键词', 'warning');
                return;
            }

            if (!searchStrategy) {
                showToast('检索策略不能为空', 'warning');
                return;
            }

            // 更新筛选条件
            updateFilters();

            // 显示加载状态
            showLoading('正在执行文献检索并生成导出文件...');

            // 发送执行检索请求
            fetch('/api/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    search_strategy: searchStrategy,
                    filters: currentFilters,
                    generate_only: false,
                    execute_search: true,
                    year_start: yearStart || null,
                    year_end: yearEnd || null,
                    export_files: true  // 添加导出文件标志
                })
            })
            .then(response => handleFetchError(response))
            .then(data => {
                hideLoading();
                if (data.success) {
                    // 更新检索统计信息
                    const searchStats = document.getElementById('search-stats');
                    searchStats.innerHTML = `
                        <div class="alert alert-info">
                            <div class="d-flex flex-column gap-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-search me-2"></i>
                                        初始检索到相关文献：<strong id="total-count">${data.total_count || 0}</strong> 篇
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-filter me-2"></i>
                                        符合筛选条件的文献：<strong id="filtered-count">${data.filtered_count || 0}</strong> 篇
                                    </span>
                                </div>
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-primary" role="progressbar" 
                                        style="width: ${data.filtered_count / data.total_count * 100}%"
                                        aria-valuenow="${data.filtered_count}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="${data.total_count}">
                                    </div>
                                </div>
                                <div class="mt-2 text-muted small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    筛选条件包括：年份、影响因子、JCR分区、CAS分区
                                </div>
                            </div>
                        </div>
                    `;
                    searchStats.style.display = 'block';

                    // 如果有导出文件，自动下载
                    if (data.export_files) {
                        // 添加导出文件信息到统计区域
                        const exportInfo = `
                            <div class="alert alert-success mt-3">
                                <h6 class="mb-2">
                                    <i class="fas fa-file-export me-2"></i>导出文件已自动下载：
                                </h6>
                                <div class="ms-3">
                                    <p class="mb-1">
                                        <i class="fas fa-check-circle me-2 text-success"></i>Excel文件
                                    </p>
                                    <p class="mb-1">
                                        <i class="fas fa-check-circle me-2 text-success"></i>Word文件
                                    </p>
                                </div>
                            </div>
                        `;
                        searchStats.insertAdjacentHTML('beforeend', exportInfo);

                        // 自动下载文件
                        if (data.excel_file) {
                            window.open(`/exports/${data.excel_file}`, '_blank');
                        }
                        if (data.word_file) {
                            setTimeout(() => {
                                window.open(`/exports/${data.word_file}`, '_blank');
                            }, 1000); // 延迟1秒下载第二个文件，避免浏览器阻止
                        }
                    }

                    // 显示搜索结果
                    displayResults(data.data);
                    
                    // 保存当前检索策略
                    currentSearchStrategy = searchStrategy;
                    
                    showToast(`检索完成，共找到 ${data.filtered_count || 0} 篇相关文献，文件已自动下载`, 'success');
                } else {
                    showToast(data.error || '检索失败', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                showToast('执行检索时发生错误: ' + error.message, 'error');
                console.error('Error:', error);
            });
        });

        // 添加错误处理函数
        function handleFetchError(response) {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        }

        // 模式切换处理
        document.querySelectorAll('input[name="search-mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const normalMode = document.getElementById('normal-mode-container');
                const analysisMode = document.getElementById('analysis-mode-container');
                
                if (this.value === 'normal') {
                    normalMode.style.display = 'block';
                    analysisMode.style.display = 'none';
                } else {
                    normalMode.style.display = 'none';
                    analysisMode.style.display = 'block';
                }
            });
        });

        // 热点分析功能
        document.getElementById('analyze-btn').addEventListener('click', function() {
            const journal = document.getElementById('journal-input').value.trim();
            const keywords = document.getElementById('keywords-input').value.trim();
            const startYear = document.getElementById('analysis-year-start').value;
            const endYear = document.getElementById('analysis-year-end').value;
            
            if (!journal || !startYear || !endYear) {
                showToast('请至少填写期刊名称和时间范围', 'warning');
                return;
            }
            
            // 显示加载状态
            showLoading('正在分析期刊数据...');
            
            // 调用后端API
            fetch('/api/analyze-journal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    journal: journal,
                    keywords: keywords,
                    start_year: startYear,
                    end_year: endYear
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    displayAnalysisResults(data);
                    showToast('期刊分析完成', 'success');
                } else {
                    showToast(data.error || '分析失败', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                showToast('分析过程中发生错误: ' + error.message, 'error');
            });
        });

        // 在分析结果处理函数中添加热点作者表格的渲染
        function displayAnalysisResults(data) {
            document.getElementById('analysis-results').style.display = 'block';
            
            // 等待DOM更新完成后再初始化图表
            setTimeout(() => {
                // 重新初始化所有图表容器
                const containers = ['heatmap-container', 'wordcloud-container', 'trend-container'];
                containers.forEach(id => {
                    const container = document.getElementById(id);
                    const chart = echarts.getInstanceByDom(container);
                    if (chart) {
                        chart.dispose();
                    }
                });

                // 渲染热图
                if (data.heatmap_data && data.heatmap_data.length > 0) {
                    drawHeatmap(data.heatmap_data);
                } else {
                    document.getElementById('heatmap-container').innerHTML = 
                        '<div class="text-center p-4">暂无热点分布数据</div>';
                }

                // 渲染词云
                if (data.wordcloud_data && data.wordcloud_data.length > 0) {
                    drawWordCloud(data.wordcloud_data);
                } else {
                    document.getElementById('wordcloud-container').innerHTML = 
                        '<div class="text-center p-4">暂无词云数据</div>';
                }

                // 渲染趋势图
                if (data.trend_data && data.trend_data.topics && data.trend_data.topics.length > 0) {
                    drawTrendChart(data.trend_data);
                } else {
                    document.getElementById('trend-container').innerHTML = 
                        '<div class="text-center p-4">暂无趋势数据</div>';
                }
            }, 100);
            
            // 渲染热点作者表格
            const authorsTable = document.getElementById('hot-authors-table');
            if (data.hot_authors && data.hot_authors.length > 0) {
                authorsTable.innerHTML = data.hot_authors.map((author, index) => `
                    <tr>
                        <td class="author-rank">${index + 1}</td>
                        <td>${author.name || 'N/A'}</td>
                        <td>${author.total_papers || 0}</td>
                        <td>${author.first_author || 0}</td>
                        <td>${author.corresponding_author || 0}</td>
                        <td class="author-years">${author.years ? author.years.join(', ') : 'N/A'}</td>
                    </tr>
                `).join('');
            } else {
                authorsTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">暂无热点作者数据</td>
                    </tr>
                `;
            }
        }

        // 绘制热力图
        function drawHeatmap(data) {
            const container = document.getElementById('heatmap-container');
            if (!container) return;
            
            const chart = echarts.init(container);
            
            // 准备数据
            const size = Math.ceil(Math.sqrt(data.length));
            const matrix = new Array(size).fill(0).map(() => new Array(size).fill(0));
            const labels = new Array(size).fill(0).map(() => new Array(size).fill(''));
            
            data.forEach((item, index) => {
                const row = Math.floor(index / size);
                const col = index % size;
                if (row < size && col < size) {
                    matrix[row][col] = item[1];  // 使用文章数量作为热度值
                    labels[row][col] = item[0];  // 使用主题名称作为标签
                }
            });
            
            // 配置项
            const option = {
                title: {
                    text: '研究热点分布',
                    left: 'center'
                },
                tooltip: {
                    position: 'top',
                    formatter: function(params) {
                        const word = labels[params.data[0]][params.data[1]];
                        const value = params.data[2];
                        if (word && value) {
                            return `${word}<br/>文章数量: ${value}`;
                        }
                        return '';
                    }
                },
                animation: true,
                grid: {
                    height: '70%',
                    top: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: new Array(size).fill(0).map((_, i) => i),
                    splitArea: {
                        show: true
                    },
                    axisLabel: {show: false},
                    splitLine: {show: false}
                },
                yAxis: {
                    type: 'category',
                    data: new Array(size).fill(0).map((_, i) => i),
                    splitArea: {
                        show: true
                    },
                    axisLabel: {show: false},
                    splitLine: {show: false}
                },
                visualMap: {
                    min: 0,
                    max: Math.max(...matrix.flat()),
                    calculable: true,
                    orient: 'horizontal',
                    left: 'center',
                    bottom: '5%',
                    inRange: {
                        color: ['#f5f5f5', '#4169E1']
                    }
                },
                series: [{
                    name: '研究热点',
                    type: 'heatmap',
                    data: matrix.map((row, i) => 
                        row.map((val, j) => [i, j, val])
                    ).flat().filter(item => item[2] > 0),  // 只显示有值的单元格
                    label: {
                        show: true,
                        formatter: function(params) {
                            return labels[params.data[0]][params.data[1]];
                        },
                        fontSize: 10,
                        color: '#333',
                        fontWeight: 'bold'
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            
            // 设置图表大小
            chart.resize({
                height: container.clientHeight || 400
            });
            
            // 渲染图表
            chart.setOption(option);
            
            // 监听容器大小变化
            window.addEventListener('resize', () => {
                chart.resize();
            });
        }

        // 绘制词云
        function drawWordCloud(data) {
            const container = document.getElementById('wordcloud-container');
            const chart = echarts.init(container);
            
            const option = {
                tooltip: {
                    show: true,
                    formatter: function(params) {
                        return `${params.data.name}: ${params.data.value}次`;
                    }
                },
                series: [{
                    type: 'wordCloud',
                    shape: 'circle',
                    left: 'center',
                    top: 'center',
                    width: '90%',
                    height: '90%',
                    right: null,
                    bottom: null,
                    sizeRange: [12, 60],
                    rotationRange: [-45, 45],
                    rotationStep: 45,
                    gridSize: 8,
                    drawOutOfBound: false,
                    textStyle: {
                        fontFamily: 'sans-serif',
                        fontWeight: 'bold',
                        color: function() {
                            return 'rgb(' + [
                                Math.round(Math.random() * 160),
                                Math.round(Math.random() * 160),
                                Math.round(Math.random() * 160)
                            ].join(',') + ')';
                        }
                    },
                    emphasis: {
                        textStyle: {
                            shadowBlur: 10,
                            shadowColor: '#333'
                        }
                    },
                    data: data.map(([name, value]) => ({
                        name,
                        value,
                        textStyle: {
                            color: '#4169E1'
                        }
                    }))
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 绘制趋势图
        function drawTrendChart(data) {
            const container = document.getElementById('trend-container');
            const chart = echarts.init(container);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: data.topics,
                    top: '5%'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.years,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '出现频率'
                },
                series: data.topics.map((topic, index) => ({
                    name: topic,
                    type: 'line',
                    data: data.frequencies[index],
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    lineStyle: {
                        width: 3
                    }
                }))
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 添加模式切换处理
        document.querySelectorAll('input[name="input-mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const paragraphOptions = document.getElementById('paragraph-options');
                const searchStrategyContainer = document.getElementById('search-strategy-container');
                const results = document.getElementById('results');
                const searchStats = document.getElementById('search-stats');
                
                if (this.value === 'paragraph') {
                    // 段落模式
                    paragraphOptions.style.display = 'block';
                    searchStrategyContainer.style.display = 'none';
                    document.getElementById('search-btn').textContent = '开始分析';
                } else {
                    // 单句模式
                    paragraphOptions.style.display = 'none';
                    results.style.display = 'none';
                    searchStats.style.display = 'none';
                    document.getElementById('search-btn').textContent = '生成检索策略';
                }
            });
        });

        // 添加段落结果显示函数
        function displayParagraphResults(data) {
            const resultsList = document.getElementById('resultsList');
            const results = document.getElementById('results');
            
            if (!data.sentences || data.sentences.length === 0) {
                resultsList.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        未找到可分析的句子
                    </div>`;
                results.style.display = 'block';
                return;
            }

            let html = `
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    共分析 ${data.sentences.length} 个句子
                </div>
            `;

            data.sentences.forEach((sentence, index) => {
                html += `
                    <div class="sentence-result">
                        <div class="sentence-text">
                            <strong>句子 ${index + 1}:</strong> ${sentence.text}
                        </div>
                        <div class="search-strategy mb-3">
                            <h6 class="mb-2">检索策略：</h6>
                            <div class="bg-light p-2 rounded">
                                <code>${sentence.search_strategy || '未生成检索策略'}</code>
                            </div>
                        </div>
                        <div class="papers-list">
                            <h6 class="mb-3">相关文献：</h6>
                            ${sentence.papers.map((paper, pIndex) => `
                                <div class="paper-item">
                                    <h6 class="paper-title mb-2">
                                        ${pIndex + 1}. ${paper.title}
                                    </h6>
                                    <div class="paper-meta">
                                        <span class="me-3">
                                            <i class="fas fa-users me-1"></i>
                                            ${paper.authors ? paper.authors.join(', ') : '无作者信息'}
                                        </span>
                                        <span class="me-3">
                                            <i class="fas fa-calendar me-1"></i>
                                            ${paper.pub_year || '无日期信息'}
                                        </span>
                                        <span class="me-3">
                                            <i class="fas fa-book me-1"></i>
                                            ${paper.journal_info ? paper.journal_info.title : '无期刊信息'}
                                        </span>
                                        <span class="me-3">
                                            <i class="fas fa-chart-line me-1"></i>
                                            IF: ${paper.journal_info ? paper.journal_info.impact_factor : 'N/A'}
                                        </span>
                                        <span class="me-3">
                                            <i class="fas fa-star me-1"></i>
                                            JCR: ${paper.journal_info ? paper.journal_info.jcr_quartile : 'N/A'}
                                        </span>
                                        <span class="me-3">
                                            <i class="fas fa-award me-1"></i>
                                            CAS: ${paper.journal_info ? paper.journal_info.cas_quartile : 'N/A'}
                                        </span>
                                        <span class="me-3">
                                            <i class="fas fa-percentage me-1"></i>
                                            相关度: ${paper.relevance ? paper.relevance.toFixed(1) : 0}%
                                        </span>
                                    </div>
                                    <div class="mt-2">
                                        <a href="https://pubmed.ncbi.nlm.nih.gov/${paper.pmid}/" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="fas fa-external-link-alt me-1"></i>
                                            查看原文
                                        </a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            resultsList.innerHTML = html;
            results.style.display = 'block';
            
            // 隐藏检索策略相关元素
            document.getElementById('search-strategy-container').style.display = 'none';
            document.getElementById('search-stats').style.display = 'none';
        }
    </script>
</body>
</html> 